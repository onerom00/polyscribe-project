<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PolyScribe · Transcriptor Global</title>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Estilos -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme_light.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/badge.css') }}">

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#0b1424;
      --accent:#22c55e; --accent-2:#60a5fa; --danger:#ef4444;
      --card:#ffffff; --border:#d9e4f7; --fs:1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#a6d6fb 0%, #9acef8 100%) fixed;
      color:var(--text); font-size:calc(16px * var(--fs));
    }
    .container{max-width:1080px;margin:32px auto;padding:0 16px}
    h1{margin:0;font-size:26px;font-weight:700;color:#0b1424}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:1fr 1fr}
    label{font-size:15px;font-weight:700;margin-bottom:8px;display:block}
    select,button,input,textarea{font-family:inherit}
    .row{display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap}
    select{background:#fff;border:1px solid #c6d3ec;color:#0b1424;padding:8px 10px;border-radius:10px;min-width:220px}
    .btn{background:#0b62e0;border:1px solid #0a59c9;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn:hover{filter:brightness(1.02)}
    .btn-primary{background:var(--accent);border-color:#16a34a;color:#0b111d;font-weight:800;box-shadow:0 0 0 3px rgba(34,197,94,.18) inset}
    .dropzone{border:2px dashed #97bff7;border-radius:14px;padding:22px;text-align:center;color:#24508f;background:#f1f7ff}
    .dropzone:hover{border-color:#60a5fa}
    .help{font-size:15px;color:#113160;margin-bottom:6px}
    .formats{font-size:13px;color:#0b62e0;font-weight:700}
    textarea{
      width:100%;min-height:220px;background:#fff;border:1px solid #c6d3ec;color:#0b1424;border-radius:12px;padding:12px;resize:vertical;line-height:1.7;
      text-align:justify;text-justify:inter-word;hyphens:auto;
    }
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .details{font-size:14px;color:#13406f}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #c6d3ec;background:#fff;border-radius:999px;padding:4px 10px;margin-right:8px;color:#0b1424}
    .alert{background:#fde2e2;border:1px solid #f3abab;color:#8a1c1c;padding:10px;border-radius:12px;margin-bottom:12px;display:none}
    .alert.success{color:#0f5132;background:#d1f7e7;border-color:#94e2c1}
    .hidden{display:none}
    @media (max-width:900px){.grid-2{grid-template-columns:1fr}}

    header.ps-nav{background:#fff;border-bottom:1px solid var(--border)}
    .ps-nav .inner{max-width:1080px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .ps-nav .brand{font-weight:800;color:#0b1424;text-decoration:none}
    .ps-nav .links a{margin-right:14px;text-decoration:none;color:#13406f;font-weight:700}
    .ps-nav .links a.active{color:#0b62e0}
    .badge-usage{display:inline-flex;align-items:center;gap:8px;background:#e8f3ff;color:#0b1424;border:1px solid #b9d9ff;border-radius:999px;padding:5px 10px;font-size:13px;font-weight:700}
    .a11y-btn{background:#f2f6ff;border:1px solid #cddaf5;color:#0b1424;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:600;font-size:.95rem}
  </style>
</head>

<body data-user-id="{{ user_id|default('') }}">

  <!-- HEADER -->
  <header class="ps-nav">
    <div class="inner">
      <a class="brand" href="/">PolyScribe</a>
      <nav class="links ps-nav-links">
        <a href="/" data-path="/">Transcribir</a>
        <a href="/history" data-path="/history">Historial</a>
        <a href="/pricing" data-path="/pricing">Precios</a>
        <a href="/ayuda" data-path="/ayuda">Ayuda</a>
      </nav>
      <div class="right">
        <span id="usage-badge-nav" class="badge-usage">
          <span id="usage-text-nav">—/— min · libre —</span>
        </span>
        <a href="#login" class="a11y-btn" id="nav-login-link">Entrar</a>
        <a href="#signup" class="a11y-btn" style="background:#22c55e;border-color:#16a34a;color:#0b111d">Registro</a>
      </div>
    </div>
  </header>

  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;margin:18px 0">
      <h1>PolyScribe · Transcriptor Global</h1>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <div class="badge-usage" id="usage-badge">
          <span id="usage-text">—/— min · libre —</span>
        </div>
        <button class="a11y-btn" id="btn-refresh">Refrescar</button>
        <button class="a11y-btn" id="btn-a11y">A+</button>
        <button class="a11y-btn" id="btn-contrast">HC</button>
        <button class="a11y-btn" id="btn-history">Historial</button>
      </div>
    </div>

    <p class="details">Sube tu audio y recibe transcripción + resumen.</p>
    <div class="alert" id="alert-box"></div>

    <div class="card grid" style="gap:20px">

      <!-- Selector idioma -->
      <div class="row">
        <label for="idioma-select">Idioma</label>
        <select id="idioma-select">
          <option value="auto" selected>Auto (recomendado)</option>
          <option value="es">ES Español</option>
          <option value="en">EN English</option>
          <option value="pt">PT Português</option>
          <option value="fr">FR Français</option>
          <option value="it">IT Italiano</option>
          <option value="de">DE Deutsch</option>
          <option value="ca">CA Català</option>
          <option value="zh">ZH 中文</option>
          <option value="ja">JP 日本語</option>
          <option value="ko">KR 한국어</option>
          <option value="ar">AR عربي</option>
        </select>
        <button class="btn" id="btn-reset">Restablecer</button>
      </div>

      <small class="details" style="margin-top:-6px">
        Sugerencia: “Auto” soporta 30+ idiomas (ru, pl, uk, tr, he, fa, hi, bn, ta, te, vi, id, ms…).
      </small>

      <!-- Dropzone -->
      <div class="dropzone" id="dropzone">
        <div class="help">Arrastra tu archivo aquí o haz clic para seleccionar</div>
        <div class="formats">Formatos: mp3, wav, m4a, ogg, webm… <b>Máx. 100 MB</b></div>
        <input type="file" id="audio-file" accept=".mp3,.wav,.m4a,.ogg,.oga,.webm,.mp4,.mpeg,.mpga,.flac" class="hidden">
      </div>

      <!-- Botón transcribir -->
      <div><button class="btn btn-primary" id="btn-transcribir">Transcribir</button></div>

      <!-- Resultado -->
      <div class="grid grid-2">
        <div>
          <label>Transcripción</label>
          <textarea id="transcript" placeholder="Aquí aparecerá la transcripción…"></textarea>
          <div class="toolbar">
            <button class="btn" id="copy-trans">Copiar</button>
            <button class="btn" id="download-txt">TXT</button>
            <button class="btn" id="download-srt">SRT</button>
            <button class="btn" id="download-vtt">VTT</button>
            <button class="btn" id="download-docx">DOCX</button>
            <button class="btn" id="download-pdf">PDF</button>
          </div>
        </div>

        <div>
          <label>Resumen</label>
          <textarea id="summary" placeholder="Aquí aparecerá el resumen…"></textarea>
          <div class="toolbar">
            <button class="btn" id="copy-sum">Copiar</button>
            <button class="btn" id="download-sum">Descargar Resumen</button>
            <button class="btn" id="download-json">Descargar JSON</button>
          </div>
        </div>
      </div>

      <div class="details" id="details">
        <span class="pill"><strong>Archivo:</strong> <span id="d-file">—</span></span>
        <span class="pill"><strong>Idioma elegido:</strong> <span id="d-lang">auto</span></span>
        <span class="pill"><strong>Idioma detectado:</strong> <span id="d-det">—</span></span>
        <span class="pill"><strong>Job ID:</strong> <span id="d-job">—</span></span>
      </div>
    </div>
  </div>

  <!-- JS auxiliar (login / registro demo) -->
  <script src="{{ url_for('static', filename='js/nav_auth.js') }}"></script>

  <!-- Lógica principal -->
  <script>
  (function(){
    const $ = s => document.querySelector(s);

    // ============================
    // USER ID
    // ============================
    let USER_ID = (document.body.dataset.userId || "").trim();
    if (!USER_ID) USER_ID = localStorage.getItem("user_id") || "";
    if (USER_ID) localStorage.setItem("user_id", USER_ID);
    if (!USER_ID) USER_ID = "guest";

    // ============================
    // Helpers genéricos
    // ============================
    function downloadBlob(filename, mime, blobOrText){
      const blob = blobOrText instanceof Blob
        ? blobOrText
        : new Blob([blobOrText], {type: mime || "application/octet-stream"});

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename || "resultado";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function copyToClipboard(text){
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(
          () => showOk("Texto copiado al portapapeles."),
          ()  => fallback()
        );
      } else {
        fallback();
      }

      function fallback(){
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); }catch(e){}
        document.body.removeChild(ta);
        showOk("Texto copiado al portapapeles.");
      }
    }

    // ============================
    // API helper (JSON)
    // ============================
    async function api(url, opts = {}){
      try{
        const h = opts.headers ? {...opts.headers} : {};
        if (USER_ID !== "guest" && !h["X-User-Id"]) h["X-User-Id"] = USER_ID;
        const res = await fetch(url, {...opts, headers:h});
        const txt = await res.text();
        let body;
        try{ body = JSON.parse(txt); }catch{ body = txt; }
        return {ok:res.ok, status:res.status, body};
      }catch(e){
        return {ok:false, status:0, body:{error:String(e)}};
      }
    }

    // ============================
    // BADGE USO
    // ============================
    async function refreshBadge(){
      const url = `/api/usage/balance?user_id=${encodeURIComponent(USER_ID)}`;
      const r = await api(url);
      if (!r.ok){
        document.getElementById("usage-badge").style.display="none";
        document.getElementById("usage-badge-nav").style.display="none";
        return;
      }

      const data = r.body || {};
      const usedSec      = Number(data.used_seconds || 0);
      const allowanceSec = Number(data.allowance_seconds || 0);

      const usedMin      = usedSec / 60;
      const allowMin     = allowanceSec / 60;
      const remainMin    = allowMin - usedMin;

      const usedLabel   = usedMin.toFixed(1);
      const allowLabel  = allowMin.toFixed(0);
      const remainLabel = Math.max(0, remainMin).toFixed(1);

      const text = `${usedLabel}/${allowLabel} min · libre ${remainLabel} min`;
      document.getElementById("usage-text").textContent = text;
      document.getElementById("usage-text-nav").textContent = text;
    }
    document.getElementById("btn-refresh").addEventListener("click", refreshBadge);
    refreshBadge();

    // ============================
    // ELEMENTOS PRINCIPALES
    // ============================
    const idiomaSel = $("#idioma-select");
    const fileInput = $("#audio-file");
    const drop      = $("#dropzone");
    const btnTrans  = $("#btn-transcribir");
    const btnReset  = $("#btn-reset");
    const taT       = $("#transcript");
    const taS       = $("#summary");
    const alertBox  = $("#alert-box");
    const dFile     = $("#d-file");
    const dLang     = $("#d-lang");
    const dDet      = $("#d-det");
    const dJob      = $("#d-job");
    const MAX_MB    = 100;

    function showError(x){
      alertBox.textContent = x;
      alertBox.classList.remove("success");
      alertBox.style.display = "block";
    }
    function showOk(x){
      alertBox.textContent = x;
      alertBox.classList.add("success");
      alertBox.style.display = "block";
    }
    function clearAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("success");
    }

    function applyDirection(code){
      const rtl = ["ar","he","fa","ur","ps"];
      const c   = (code||"").slice(0,2);
      [taT,taS].forEach(el => el.setAttribute("dir", rtl.includes(c) ? "rtl" : "ltr"));
    }

    // ============================
    // Dropzone / archivo
    // ============================
    drop.onclick = () => fileInput.click();
    drop.ondragover = e => {e.preventDefault(); drop.style.borderColor="#60a5fa";};
    drop.ondragleave= () => {drop.style.borderColor="#97bff7";};
    drop.ondrop = e =>{
      e.preventDefault();
      drop.style.borderColor="#97bff7";
      if (e.dataTransfer.files[0]){
        fileInput.files = e.dataTransfer.files;
        dFile.textContent = e.dataTransfer.files[0].name;
      }
    };

    fileInput.onchange = () => {
      dFile.textContent = fileInput.files[0]?.name || "—";
    };

    idiomaSel.onchange = () =>{
      const code = idiomaSel.value || "auto";
      dLang.textContent = code;
      applyDirection(code);
    };

    document.getElementById("btn-history").onclick = () => {
      location.href = "/history";
    };

    // ============================
    // Crear Job (transcribir)
    // ============================
    async function crearJob(){
      clearAlert();
      const file = fileInput.files?.[0];
      if (!file) return showError("Selecciona un archivo.");
      if (file.size > MAX_MB*1024*1024) return showError("Archivo demasiado grande.");

      const lang = (idiomaSel.value||"auto").trim().toLowerCase();

      dFile.textContent = file.name;
      dLang.textContent = lang;
      applyDirection(lang);

      btnTrans.disabled = true;

      try{
        const fd = new FormData();
        fd.append("file", file);
        fd.append("language", lang);

        const r = await api("/jobs", {method:"POST", body:fd});
        if (!r.ok){
          const msg = (r.body && r.body.error) || "Error al procesar el audio.";
          return showError(msg);
        }

        const job = r.body;
        dJob.textContent = job.id || job.job_id || "—";

        taT.value = job.transcript || "";
        taS.value = job.summary || "";
        dDet.textContent = job.language_detected || "";

        showOk("Completado");
        refreshBadge();
      }
      finally{
        btnTrans.disabled = false;
      }
    }
    btnTrans.onclick = crearJob;

    // Reset
    btnReset.onclick = () =>{
      taT.value = "";
      taS.value = "";
      dFile.textContent = "—";
      dDet.textContent  = "—";
      dJob.textContent  = "—";
      idiomaSel.value   = "auto";
      dLang.textContent = "auto";
      fileInput.value   = "";
      clearAlert();
      applyDirection("auto");
    };

    // ============================
    // Copiar y descargas locales
    // ============================
    const btnCopyTrans = $("#copy-trans");
    const btnCopySum   = $("#copy-sum");
    const btnTxt       = $("#download-txt");
    const btnSumTxt    = $("#download-sum");
    const btnJson      = $("#download-json");
    const btnSrt       = $("#download-srt");
    const btnVtt       = $("#download-vtt");
    const btnDocx      = $("#download-docx");
    const btnPdf       = $("#download-pdf");

    btnCopyTrans.onclick = () => {
      if (!taT.value.trim()) return showError("No hay texto para copiar.");
      copyToClipboard(taT.value);
    };

    btnCopySum.onclick = () => {
      if (!taS.value.trim()) return showError("No hay resumen para copiar.");
      copyToClipboard(taS.value);
    };

    btnTxt.onclick = () => {
      if (!taT.value.trim()) return showError("No hay texto para exportar.");
      const base = (dFile.textContent || "transcripcion").replace(/\.[^.\s]+$/, "");
      downloadBlob(`${base}.txt`, "text/plain;charset=utf-8", taT.value || "");
    };

    btnSumTxt.onclick = () => {
      if (!taS.value.trim()) return showError("No hay resumen para exportar.");
      const base = (dFile.textContent || "resumen").replace(/\.[^.\s]+$/, "");
      downloadBlob(`${base}_resumen.txt`, "text/plain;charset=utf-8", taS.value || "");
    };

    btnJson.onclick = () => {
      if (!taT.value.trim() && !taS.value.trim()){
        return showError("No hay datos para exportar.");
      }
      const payload = {
        transcript: taT.value || "",
        summary: taS.value || "",
        language_selected: dLang.textContent || "",
        language_detected: dDet.textContent || "",
        job_id: dJob.textContent || "",
        filename: dFile.textContent || "",
        exported_at: new Date().toISOString()
      };
      const base = (dFile.textContent || "polyscribe").replace(/\.[^.\s]+$/, "");
      downloadBlob(`${base}.json`, "application/json", JSON.stringify(payload, null, 2));
    };

    // ============================
    // Descargas vía API (SRT/VTT/DOCX/PDF)
    // ============================
    async function downloadFromApi(fmt){
      if (!taT.value.trim() && !taS.value.trim()){
        return showError("No hay contenido para exportar.");
      }
      const payload = {
        transcript: taT.value || "",
        summary: taS.value || "",
        filename: dFile.textContent || "resultado"
      };

      try{
        const res = await fetch(`/api/exports/${fmt}`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        if (!res.ok){
          let msg = "Error al exportar.";
          try{
            const txt = await res.text();
            const json = JSON.parse(txt);
            if (json && json.error) msg = json.error;
          }catch(_){}
          return showError(msg);
        }

        const blob = await res.blob();
        const cd   = res.headers.get("Content-Disposition") || "";
        let fname  = `resultado.${fmt}`;
        const m = cd.match(/filename="?([^"]+)"?/i);
        if (m && m[1]) fname = m[1];

        downloadBlob(fname, blob.type, blob);
      }catch(e){
        showError("Error al exportar: " + e);
      }
    }

    btnSrt.onclick  = () => downloadFromApi("srt");
    btnVtt.onclick  = () => downloadFromApi("vtt");
    btnDocx.onclick = () => downloadFromApi("docx");
    btnPdf.onclick  = () => downloadFromApi("pdf");

  })();
  </script>
</body>
</html>
