<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PolyScribe ¬∑ Transcriptor Global</title>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Estilos globales existentes -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme_light.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/badge.css') }}">

  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --muted:#94a3b8;
      --text:#0b1424;
      --accent:#22c55e;
      --accent-2:#0b62e0;
      --danger:#ef4444;
      --card:#ffffff;
      --border:#d9e4f7;
      --fs:1;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#a6d6fb 0%, #9acef8 100%) fixed;
      color:var(--text);
      font-size:calc(16px * var(--fs));
    }

    .container{
      max-width:1160px;
      margin:32px auto 40px;
      padding:0 16px;
    }

    h1{
      margin:0;
      font-size:26px;
      font-weight:700;
      color:#0b1424;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px 18px 20px;
      box-shadow:0 10px 28px rgba(15,35,52,.16);
    }

    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:1.1fr 0.9fr}

    label{
      font-size:15px;
      font-weight:700;
      margin-bottom:8px;
      display:block;
    }

    select,button,input,textarea{font-family:inherit}

    .row{
      display:flex;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    select{
      background:#fff;
      border:1px solid #c6d3ec;
      color:#0b1424;
      padding:8px 10px;
      border-radius:10px;
      min-width:220px;
    }

    .btn{
      background:#0b62e0;
      border:1px solid #0a59c9;
      color:#fff;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:0.95rem;
      transition:transform .08s ease, box-shadow .08s ease, filter .08s ease;
    }

    .btn:hover{
      filter:brightness(1.03);
      box-shadow:0 6px 16px rgba(37,99,235,0.28);
      transform:translateY(-1px);
    }

    .btn:disabled{
      opacity:0.65;
      cursor:default;
      transform:none;
      box-shadow:none;
    }

    .btn-primary{
      background:var(--accent);
      border-color:#16a34a;
      color:#0b111d;
      font-weight:800;
      box-shadow:0 0 0 3px rgba(34,197,94,.18) inset;
    }

    .dropzone{
      border:2px dashed #97bff7;
      border-radius:14px;
      padding:22px;
      text-align:center;
      color:#24508f;
      background:#f1f7ff;
      transition:border-color .12s ease, background .12s ease, box-shadow .12s ease;
    }

    .dropzone:hover{
      border-color:#60a5fa;
      box-shadow:0 4px 12px rgba(15,23,42,0.1);
    }

    .help{
      font-size:15px;
      color:#113160;
      margin-bottom:6px;
    }

    .formats{
      font-size:13px;
      color:#0b62e0;
      font-weight:700;
    }

    textarea{
      width:100%;
      min-height:220px;
      background:#fff;
      border:1px solid #c6d3ec;
      color:#0b1424;
      border-radius:12px;
      padding:12px;
      resize:vertical;
      line-height:1.7;
    }

    /* Solo la transcripci√≥n justificada */
    #transcript{
      text-align:justify;
      text-justify:inter-word;
      hyphens:auto;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .details{
      font-size:14px;
      color:#13406f;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid #c6d3ec;
      background:#fff;
      border-radius:999px;
      padding:4px 10px;
      margin-right:8px;
      margin-top:6px;
      color:#0b1424;
      font-size:13px;
    }

    .alert{
      background:#fde2e2;
      border:1px solid #f3abab;
      color:#8a1c1c;
      padding:10px;
      border-radius:12px;
      margin-bottom:12px;
      display:none;
      font-size:14px;
    }

    .alert.success{
      color:#0f5132;
      background:#d1f7e7;
      border-color:#94e2c1;
    }

    /* ‚ÄúProcesando‚Ä¶‚Äù en amarillo premium */
    .alert.info{
      background:#fff7cc;
      border:1px solid #fde68a;
      color:#92400e;
    }

    .hidden{display:none}

    @media (max-width:900px){
      .grid-2{grid-template-columns:1fr}
    }

    /* NAV */
    header.ps-nav{
      background:#fff;
      border-bottom:1px solid var(--border);
    }

    .ps-nav .inner{
      max-width:1160px;
      margin:0 auto;
      padding:10px 16px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }

    .ps-nav .brand{
      font-weight:800;
      color:#0b1424;
      text-decoration:none;
      font-size:1.05rem;
    }

    .ps-nav .links a{
      margin-right:14px;
      text-decoration:none;
      color:#13406f;
      font-weight:700;
      font-size:0.95rem;
    }

    .ps-nav .links a.active{
      color:#0b62e0;
    }

    .badge-usage{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#e8f3ff;
      color:#0b1424;
      border:1px solid #b9d9ff;
      border-radius:999px;
      padding:5px 10px;
      font-size:13px;
      font-weight:700;
    }

    .a11y-btn{
      background:#f2f6ff;
      border:1px solid #cddaf5;
      color:#0b1424;
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      font-size:.95rem;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .steps-strip{
      margin:6px 0 14px;
      font-size:13px;
      color:#0b1424;
      background:rgba(255,255,255,0.75);
      border:1px solid #cbdcf8;
      border-radius:999px;
      padding:6px 14px;
      display:inline-flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
    }

    .steps-strip span{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .steps-strip b{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:999px;
      background:#0b62e0;
      color:#fff;
      font-size:11px;
    }

    /* Banner saldo (low / zero) */
    .credits-banner{
      display:none;
      margin:10px 0 12px;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid #fde68a;
      background:#fff7cc;
      color:#92400e;
      font-size:14px;
      box-shadow:0 6px 16px rgba(15,23,42,0.08);
    }
    .credits-banner.zero{
      border-color:#fbbf24;
      background:#ffefb3;
    }
    .credits-banner .rowb{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .credits-banner .cta{
      background:#0b62e0;
      border:1px solid #0a59c9;
      color:#fff;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .credits-banner .sub{
      margin-top:6px;
      color:#7b3d00;
      font-size:13px;
    }

    /* ============================
       ‚úÖ DEMO SECTION (nuevo)
       ============================ */
    .demo-wrap{
      margin:14px 0 16px;
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width:900px){
      .demo-wrap{grid-template-columns:1fr}
    }
    .demo-card{
      background:#ffffff;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 10px 28px rgba(15,35,52,.12);
      overflow:hidden;
    }
    .demo-head{
      padding:14px 16px 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .demo-title{
      margin:0;
      font-size:16px;
      font-weight:800;
      color:#0b1424;
    }
    .demo-sub{
      margin:6px 0 0;
      font-size:13px;
      color:#13406f;
    }
    .demo-video{
      width:100%;
      height:auto;
      display:block;
      background:#0b1424;
      border-top:1px solid #eef3ff;
    }
    .demo-side{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .demo-bullets{
      margin:0;
      padding-left:18px;
      color:#113160;
      font-size:13px;
      line-height:1.6;
    }
    .demo-cta{
      margin-top:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .demo-cta .btn{
      width:auto;
    }
    .demo-note{
      font-size:12px;
      color:#4b5563;
    }
  </style>
</head>

<body data-user-id="{{ user_id|default('') }}">

  <!-- HEADER -->
  <header class="ps-nav">
    <div class="inner">
      <a class="brand" href="/">PolyScribe</a>
      <nav class="links ps-nav-links">
        <a href="/" data-path="/">Transcribir</a>
        <a href="/history" data-path="/history">Historial</a>
        <a href="/pricing" data-path="/pricing">Precios</a>
        <a href="/ayuda" data-path="/ayuda">Ayuda</a>
      </nav>
      <div class="right">
        <span id="usage-badge-nav" class="badge-usage">
          <span id="usage-text-nav">‚Äî/‚Äî min ¬∑ libre ‚Äî</span>
        </span>
        <a href="/auth/login" class="a11y-btn" id="nav-login-link">Entrar</a>
<a href="/auth/register" class="a11y-btn" id="nav-signup-link"
   style="background:#22c55e;border-color:#16a34a;color:#0b111d">
  Registro
</a>
        </a>
      </div>
    </div>
  </header>

  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;margin:18px 0 4px;">
      <div>
        <h1>PolyScribe ¬∑ Transcriptor Global</h1>
        <div class="steps-strip">
          <span><b>1</b> Sube tu archivo</span>
          <span><b>2</b> Elige idioma (opcional)</span>
          <span><b>3</b> Pulsa <strong>Transcribir</strong></span>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <div class="badge-usage" id="usage-badge">
          <span id="usage-text">‚Äî/‚Äî min ¬∑ libre ‚Äî</span>
        </div>
        <button class="a11y-btn" id="btn-refresh">Refrescar</button>
        <button class="a11y-btn" id="btn-a11y">A+</button>
        <button class="a11y-btn" id="btn-contrast">HC</button>
        <button class="a11y-btn" id="btn-history">Historial</button>
      </div>
    </div>

    <p class="details">Sube tu audio y recibe transcripci√≥n + resumen.</p>

    <!-- ‚úÖ DEMO (nuevo bloque) -->
    <div class="demo-wrap">
      <div class="demo-card">
        <div class="demo-head">
          <div>
            <h2 class="demo-title">üé¨ Demo r√°pido (40s)</h2>
            <p class="demo-sub">Mira el flujo completo: sube ‚Üí IA procesa ‚Üí transcripci√≥n + resumen ‚Üí exporta.</p>
          </div>
          <a class="a11y-btn" href="/pricing" style="white-space:nowrap;">Ver planes</a>
        </div>

        <video class="demo-video" controls autoplay muted loop playsinline preload="metadata">
          <source src="{{ url_for('static', filename='demo/polyscribe-demo.mp4') }}" type="video/mp4">
          Tu navegador no soporta video HTML5.
        </video>
      </div>

      <div class="demo-card demo-side">
        <div style="font-weight:800;color:#0b1424;">Qu√© vas a lograr</div>
        <ul class="demo-bullets">
          <li>Transcribe audio/video en segundos con calidad profesional.</li>
          <li>Resumen con puntos clave listo para copiar y compartir.</li>
          <li>Exporta en PDF, DOCX, SRT, VTT, TXT y JSON.</li>
          <li>Historial por usuario + ‚ÄúVolver‚Äù inteligente sin pantalla vac√≠a.</li>
        </ul>

        <div class="demo-cta">
          <button class="btn btn-primary" type="button" onclick="document.getElementById('audio-file').click()">
            üöÄ Probar ahora
          </button>
          <a class="btn" href="/history" style="text-decoration:none;display:inline-flex;align-items:center;">
            üìÇ Ver historial
          </a>
        </div>

        <div class="demo-note">Tip: si no inicia autoplay en m√≥vil, es normal: iOS suele requerir interacci√≥n del usuario.</div>
      </div>
    </div>

    <!-- Banner saldo bajo / cero -->
    <div class="credits-banner" id="credits-banner">
      <div class="rowb">
        <div id="credits-msg">‚Äî</div>
        <a class="cta" href="/pricing" id="btn-upgrade">üöÄ Mejorar plan</a>
      </div>
      <div class="sub" id="credits-sub">üîí Tus transcripciones anteriores se conservan.</div>
    </div>

    <div class="alert" id="alert-box"></div>

    <div class="card grid" style="gap:20px">

      <!-- Selector idioma -->
      <div class="row">
        <label for="idioma-select">Idioma</label>
        <select id="idioma-select">
          <option value="auto" selected>Auto (recomendado)</option>
          <option value="es">ES Espa√±ol</option>
          <option value="en">EN English</option>
          <option value="pt">PT Portugu√™s</option>
          <option value="fr">FR Fran√ßais</option>
          <option value="it">IT Italiano</option>
          <option value="de">DE Deutsch</option>
          <option value="ca">CA Catal√†</option>
          <option value="zh">ZH ‰∏≠Êñá</option>
          <option value="ja">JP Êó•Êú¨Ë™û</option>
          <option value="ko">KR ÌïúÍµ≠Ïñ¥</option>
          <option value="ar">AR ÿπÿ±ÿ®Ÿä</option>
        </select>
        <button class="btn" id="btn-reset">Restablecer</button>
      </div>

      <small class="details" style="margin-top:-6px">
        Sugerencia: ‚ÄúAuto‚Äù soporta 30+ idiomas (ru, pl, uk, tr, he, fa, hi, bn, ta, te, vi, id, ms‚Ä¶).
      </small>

      <!-- Dropzone -->
      <div class="dropzone" id="dropzone">
        <div class="help">Arrastra tu archivo aqu√≠ o haz clic para seleccionar</div>
        <div class="formats">Formatos: mp3, wav, m4a, ogg, webm‚Ä¶ <b>M√°x. 100 MB</b></div>
        <input type="file" id="audio-file" accept=".mp3,.wav,.m4a,.ogg,.oga,.webm,.mp4,.mpeg,.mpga,.flac" class="hidden">
      </div>

      <!-- Bot√≥n transcribir -->
      <div>
        <button class="btn btn-primary" id="btn-transcribir">Transcribir</button>
      </div>

      <!-- Resultado -->
      <div class="grid grid-2">
        <div>
          <label>Transcripci√≥n</label>
          <textarea id="transcript" placeholder="Aqu√≠ aparecer√° la transcripci√≥n‚Ä¶"></textarea>
          <div class="toolbar">
            <button class="btn" id="copy-trans">Copiar</button>
            <button class="btn" id="download-txt">TXT</button>
            <button class="btn" id="download-srt">SRT</button>
            <button class="btn" id="download-vtt">VTT</button>
            <button class="btn" id="download-docx">DOCX</button>
            <button class="btn" id="download-pdf">PDF</button>
          </div>
        </div>

        <div>
          <label>Resumen</label>
          <textarea id="summary" placeholder="Aqu√≠ aparecer√° el resumen‚Ä¶"></textarea>
          <div class="toolbar">
            <button class="btn" id="copy-sum">Copiar</button>
            <button class="btn" id="download-sum">Descargar Resumen</button>
            <button class="btn" id="download-json">Descargar JSON</button>
          </div>
        </div>
      </div>

      <div class="details" id="details">
        <span class="pill"><strong>Archivo:</strong> <span id="d-file">‚Äî</span></span>
        <span class="pill"><strong>Idioma elegido:</strong> <span id="d-lang">auto</span></span>
        <span class="pill"><strong>Idioma detectado:</strong> <span id="d-det">‚Äî</span></span>
        <span class="pill"><strong>Job ID:</strong> <span id="d-job">‚Äî</span></span>
      </div>
    </div>
  </div>

  <!-- Script nav (activo en el men√∫, etc.) -->
  <script src="{{ url_for('static', filename='js/nav_auth.js') }}"></script>

  <!-- L√≥gica principal + exportaciones -->
  <script>
  (function(){
    const $ = s => document.querySelector(s);

    // ============================
    // DOM
    // ============================
    const idiomaSel  = $("#idioma-select");
    const fileInput  = $("#audio-file");
    const drop       = $("#dropzone");
    const btnTrans   = $("#btn-transcribir");
    const btnReset   = $("#btn-reset");
    const taT        = $("#transcript");
    const taS        = $("#summary");
    const dFile      = $("#d-file");
    const dLang      = $("#d-lang");
    const dDet       = $("#d-det");
    const dJob       = $("#d-job");
    const alertBox   = $("#alert-box");
    const btnRefresh = $("#btn-refresh");
    const btnHistory = $("#btn-history");
    const usageBadge = $("#usage-badge");
    const usageBadgeNav = $("#usage-badge-nav");
    const usageText  = $("#usage-text");
    const usageTextNav = $("#usage-text-nav");

    // Banner saldo
    const creditsBanner = $("#credits-banner");
    const creditsMsg = $("#credits-msg");
    const btnUpgrade = $("#btn-upgrade");

    const MAX_MB = 100;

    // ============================
    // USER ID (base)
    // ============================
    let USER_ID = (document.body.dataset.userId || "").trim();
    if (!USER_ID) USER_ID = localStorage.getItem("user_id") || "";
    if (USER_ID) localStorage.setItem("user_id", USER_ID);
    if (!USER_ID) USER_ID = "guest";

    // ‚úÖ FIX PRINCIPAL: tomar user_id/job_id del querystring (si vienen del historial)
    const qs = new URLSearchParams(window.location.search);
    const qUser = (qs.get("user_id") || "").trim();
    const qJob  = (qs.get("job_id") || "").trim();
    if (qUser) {
      USER_ID = qUser;
      try{ localStorage.setItem("user_id", USER_ID); }catch{}
    }

    // ============================
    // API helper (con X-User-Id)
    // ============================
    async function api(url, opts = {}){
      try{
        const h = opts.headers ? { ...opts.headers } : {};
        if (USER_ID !== "guest" && !h["X-User-Id"]) h["X-User-Id"] = USER_ID;
        const res = await fetch(url, { ...opts, headers: h });
        const txt = await res.text();
        let body;
        try { body = JSON.parse(txt); } catch { body = txt; }
        return { ok: res.ok, status: res.status, body };
      }catch(e){
        return { ok:false, status:0, body:{ error: String(e) } };
      }
    }

    // ============================
    // ALERTAS
    // ============================
    function showError(msg){
      alertBox.textContent = msg;
      alertBox.classList.remove("success","info");
      alertBox.style.display = "block";
    }
    function showOk(msg){
      alertBox.textContent = msg;
      alertBox.classList.remove("info");
      alertBox.classList.add("success");
      alertBox.style.display = "block";
    }
    function showInfo(msg){
      alertBox.textContent = msg;
      alertBox.classList.remove("success");
      alertBox.classList.add("info");
      alertBox.style.display = "block";
    }
    function clearAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("success","info");
    }

    // ============================
    // SALDO: LOW / ZERO
    // ============================
    const LOW_THRESHOLD_MIN = 5;
    let REMAIN_MIN = null;

    function updateCreditsUI(remainMin){
      if (!creditsBanner || !creditsMsg) return;

      if (remainMin === null || Number.isNaN(remainMin)){
        creditsBanner.style.display = "none";
        creditsBanner.classList.remove("zero");
        return;
      }

      const r = Math.max(0, remainMin);

      if (r <= 0.01){
        creditsBanner.style.display = "block";
        creditsBanner.classList.add("zero");
        creditsMsg.textContent = "‚ùå No tienes minutos disponibles. Desbloquea m√°s minutos para seguir transcribiendo.";
        return;
      }

      if (r <= LOW_THRESHOLD_MIN){
        creditsBanner.style.display = "block";
        creditsBanner.classList.remove("zero");
        creditsMsg.textContent = `‚ö†Ô∏è Te quedan solo ${r.toFixed(1)} minutos disponibles.`;
        return;
      }

      creditsBanner.style.display = "none";
      creditsBanner.classList.remove("zero");
    }

    // ============================
    // BADGE USO
    // ============================
    async function refreshBadge(){
      const url = `/api/usage/balance?user_id=${encodeURIComponent(USER_ID)}`;
      const r = await api(url);
      if (!r.ok){
        if (usageBadge) usageBadge.style.display = "none";
        if (usageBadgeNav) usageBadgeNav.style.display = "none";
        REMAIN_MIN = null;
        updateCreditsUI(REMAIN_MIN);
        return;
      }
      const data = r.body || {};
      const usedSec  = Number(data.used_seconds || 0);
      const allowSec = Number(data.allowance_seconds || 0);
      const usedMin  = usedSec / 60;
      const allowMin = allowSec / 60;
      const remain   = Math.max(0, allowMin - usedMin);

      REMAIN_MIN = remain;

      const text = `${usedMin.toFixed(1)}/${allowMin.toFixed(0)} min ¬∑ libre ${remain.toFixed(1)} min`;
      if (usageText) usageText.textContent = text;
      if (usageTextNav) usageTextNav.textContent = text;

      updateCreditsUI(REMAIN_MIN);
    }

    if (btnRefresh) btnRefresh.addEventListener("click", refreshBadge);
    refreshBadge();

    if (btnUpgrade) btnUpgrade.addEventListener("click", () => { /* link normal */ });

    // ============================
    // DIRECCI√ìN (RTL/LTR)
    // ============================
    function applyDirection(code){
      const rtl = ["ar", "he", "fa", "ur", "ps"];
      const c = (code || "").slice(0,2);
      const dir = rtl.includes(c) ? "rtl" : "ltr";
      taT.setAttribute("dir", dir);
      taS.setAttribute("dir", dir);
    }

    // ============================
    // DROPZONE
    // ============================
    drop.onclick = () => fileInput.click();
    drop.ondragover = e => {
      e.preventDefault();
      drop.style.borderColor = "#60a5fa";
    };
    drop.ondragleave = () => {
      drop.style.borderColor = "#97bff7";
    };
    drop.ondrop = e => {
      e.preventDefault();
      drop.style.borderColor = "#97bff7";
      if (e.dataTransfer.files[0]){
        fileInput.files = e.dataTransfer.files;
        dFile.textContent = e.dataTransfer.files[0].name;
      }
    };

    fileInput.onchange = () => {
      dFile.textContent = fileInput.files[0]?.name || "‚Äî";
    };

    // ============================
    // CAMBIO DE IDIOMA
    // ============================
    idiomaSel.onchange = () => {
      const code = idiomaSel.value || "auto";
      dLang.textContent = code;
      applyDirection(code);
    };

    // ============================
    // HISTORIAL
    // ============================
    if (btnHistory){
      btnHistory.onclick = () => { window.location.href = "/history"; };
    }

    // ============================
    // ‚úÖ CARGAR JOB AL ABRIR (si vienes de historial con job_id)
    // ============================
    async function loadJobFromQuery(){
      if (!qJob) return;

      clearAlert();
      showInfo("üìÑ Cargando resultado del historial‚Ä¶");
      btnTrans.disabled = true;

      try{
        const r = await api(`/jobs/${encodeURIComponent(qJob)}`, { method:"GET" });
        if (!r.ok){
          const msg = (r.body && r.body.error) ? r.body.error : "No se pudo cargar el job.";
          return showError(msg);
        }

        const job = r.body || {};
        taT.value = job.transcript || "";
        taS.value = job.summary || "";
        dDet.textContent = job.language_detected || "‚Äî";
        dJob.textContent = job.id || job.job_id || qJob;

        if (job.filename) dFile.textContent = job.filename;

        if (job.language) {
          dLang.textContent = job.language;
          if (idiomaSel) idiomaSel.value = job.language;
          applyDirection(job.language);
        }
        if (job.language_detected){
          applyDirection(job.language_detected);
        }

        try{ localStorage.setItem("ps_last_job_id", String(dJob.textContent || qJob)); }catch{}

        showOk("‚úÖ Resultado cargado desde historial.");
        refreshBadge();
      }catch(e){
        console.error(e);
        showError("Error inesperado cargando el historial.");
      }finally{
        btnTrans.disabled = false;
      }
    }

    loadJobFromQuery();

    // ============================
    // CREAR JOB
    // ============================
    async function crearJob(){
      clearAlert();

      if (REMAIN_MIN !== null && REMAIN_MIN <= 0.01){
        updateCreditsUI(REMAIN_MIN);
        showError("No tienes minutos disponibles. Pulsa ‚ÄúMejorar plan‚Äù para continuar.");
        if (creditsBanner && creditsBanner.style.display !== "none"){
          creditsBanner.scrollIntoView({behavior:"smooth", block:"center"});
        }
        return;
      }

      const file = fileInput.files?.[0];
      if (!file) return showError("Selecciona un archivo.");
      if (file.size > MAX_MB * 1024 * 1024){
        return showError("El archivo supera el l√≠mite de 100 MB.");
      }

      const lang = (idiomaSel.value || "auto").trim().toLowerCase();
      dFile.textContent = file.name;
      dLang.textContent = lang;
      applyDirection(lang);

      taT.value = "";
      taS.value = "";
      dDet.textContent = "‚Äî";
      dJob.textContent = "‚Äî";

      showInfo("‚è≥ Procesando audio‚Ä¶ por favor espera.");
      btnTrans.disabled = true;

      try{
        const fd = new FormData();
        fd.append("file", file);
        fd.append("language", lang);

        const r = await api("/jobs", { method:"POST", body: fd });
        if (!r.ok){
          if (r.body && r.body.error === "NO_CREDITS"){
            REMAIN_MIN = 0;
            updateCreditsUI(REMAIN_MIN);
            showError("No tienes minutos suficientes para este archivo. Pulsa ‚ÄúMejorar plan‚Äù para continuar.");
            if (creditsBanner && creditsBanner.style.display !== "none"){
              creditsBanner.scrollIntoView({behavior:"smooth", block:"center"});
            }
            return;
          }
          const msg = (r.body && r.body.error) || "No se pudo procesar el archivo.";
          return showError(msg);
        }

        const job = r.body || {};
        taT.value = job.transcript || "";
        taS.value = job.summary || "";
        dDet.textContent = job.language_detected || "";
        dJob.textContent = job.id || job.job_id || "‚Äî";

        if (job.language_detected){
          applyDirection(job.language_detected);
        }

        try{ localStorage.setItem("ps_last_job_id", String(dJob.textContent || "")); }catch{}

        showOk("‚úÖ Transcripci√≥n y resumen listos.");
        await refreshBadge();
      }catch(e){
        console.error(e);
        showError("Ocurri√≥ un error inesperado al procesar el archivo.");
      }finally{
        btnTrans.disabled = false;
      }
    }

    btnTrans.onclick = crearJob;

    // ============================
    // RESET
    // ============================
    btnReset.onclick = () => {
      taT.value = "";
      taS.value = "";
      dFile.textContent = "‚Äî";
      dLang.textContent = "auto";
      dDet.textContent = "‚Äî";
      dJob.textContent = "‚Äî";
      fileInput.value = "";
      idiomaSel.value = "auto";
      applyDirection("auto");
      clearAlert();
    };

    // ============================
    // EXPORT TXT CLIENTE
    // ============================
    function downloadClient(baseName, ext, content, mime){
      const safeName = baseName || "resultado";
      const blob = new Blob([content || ""], { type: mime || "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${safeName}.${ext}`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function getBaseName(){
      const name = dFile.textContent || "";
      if (!name || name === "‚Äî") return "resultado";
      return name.replace(/\.[^.]+$/, "");
    }

    // ============================
    // BOTONES TRANSCRIPCI√ìN
    // ============================
    $("#copy-trans").onclick = async () => {
      const txt = taT.value || "";
      if (!txt) return;
      try{
        await navigator.clipboard.writeText(txt);
        showOk("‚úÖ Transcripci√≥n copiada.");
      }catch{
        showError("No se pudo copiar la transcripci√≥n.");
      }
    };

    $("#download-txt").onclick = () => {
      if (!taT.value) return showError("No hay transcripci√≥n para exportar.");
      const base = getBaseName() || "transcripcion";
      downloadClient(base, "txt", taT.value, "text/plain;charset=utf-8");
    };

    async function exportServer(fmt){
      if (!taT.value){
        return showError("No hay transcripci√≥n para exportar.");
      }
      const payload = {
        transcript: taT.value || "",
        summary: taS.value || "",
        filename: dFile.textContent || ""
      };

      try{
        const res = await fetch(`/api/exports/${fmt}`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok){
          const txt = await res.text();
          let data;
          try{ data = JSON.parse(txt); }catch{ data = {}; }
          const msg = (data && data.error) || `No se pudo exportar (${fmt}).`;
          return showError(msg);
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const base = getBaseName();
        a.href = url;
        a.download = `${base}.${fmt}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }catch(e){
        console.error(e);
        showError(`No se pudo exportar (${fmt}).`);
      }
    }

    $("#download-srt").onclick  = () => exportServer("srt");
    $("#download-vtt").onclick  = () => exportServer("vtt");
    $("#download-docx").onclick = () => exportServer("docx");
    $("#download-pdf").onclick  = () => exportServer("pdf");

    // ============================
    // BOTONES RESUMEN
    // ============================
    $("#copy-sum").onclick = async () => {
      const txt = taS.value || "";
      if (!txt) return;
      try{
        await navigator.clipboard.writeText(txt);
        showOk("‚úÖ Resumen copiado.");
      }catch{
        showError("No se pudo copiar el resumen.");
      }
    };

    $("#download-sum").onclick = () => {
      if (!taS.value) return showError("No hay resumen para exportar.");
      const base = getBaseName() || "resumen";
      downloadClient(base, "txt", taS.value, "text/plain;charset=utf-8");
    };

    $("#download-json").onclick = () => {
      const obj = {
        filename: dFile.textContent || null,
        language_selected: dLang.textContent || null,
        language_detected: dDet.textContent || null,
        job_id: dJob.textContent || null,
        transcript: taT.value || "",
        summary: taS.value || ""
      };
      const json = JSON.stringify(obj, null, 2);
      const base = getBaseName();
      downloadClient(base, "json", json, "application/json;charset=utf-8");
    };

  })();
  </script>
</body>
</html>
