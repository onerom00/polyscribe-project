<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Historial · PolyScribe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#e6f0ff;--card:#fff;--text:#0b1424;--muted:#4b5563;--border:#d9e4f7;--accent:#0b62e0;}
    *{box-sizing:border-box}
    body{margin:0;background:#cfe5ff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
    .container{max-width:980px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 16px}
    a{color:var(--accent);text-decoration:none}
    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;justify-content:space-between}
    .left{display:flex;flex-direction:column;gap:6px}
    .meta{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:#1f2937;background:#f7fbff;font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:#0b62e0;border:1px solid #0a59c9;color:#fff;font-weight:700;padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center}
    .btn-secondary{background:#f2f6ff;color:#0b1424;border:1px solid #cddaf5}
    h1{font-size:20px;margin:8px 0 16px}
    nav{display:flex;gap:12px;font-weight:700;flex-wrap:wrap}
    .topbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px;align-items:center;flex-wrap:wrap}
    .badge{background:#e8f3ff;border:1px solid #b9d9ff;border-radius:999px;padding:6px 10px;color:#0b1424;font-size:12px;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .alert{display:none;margin:10px 0 12px;background:#fff4e5;border:1px solid #f4c08a;color:#7b3d00;padding:10px;border-radius:12px;font-size:14px}
    @media (max-width:700px){.card{flex-direction:column;align-items:flex-start;gap:10px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <nav>
        <a href="/">PolyScribe</a>
        <a href="/">Transcribir</a>
        <a href="/history">Historial</a>
        <a href="/pricing">Precios</a>
        <a href="/ayuda">Ayuda</a>
      </nav>
      <div class="topbar">
        <span class="badge" id="usage-text">—/— min · libre —</span>
        <!-- VOLVER INTELIGENTE -->
        <a class="btn btn-secondary" href="/" id="btn-back">Volver</a>
      </div>
    </header>

    <h1>Historial</h1>
    <div class="muted">Tus transcripciones recientes (según tu usuario actual).</div>
    <div class="alert" id="alert-box"></div>

    <div class="cards" id="cards"></div>

    <p class="muted" id="empty" style="display:none;margin-top:14px;">No hay registros.</p>
  </div>

  <script>
    (function(){
      const $ = (s) => document.querySelector(s);

      const cards = $("#cards");
      const empty = $("#empty");
      const alertBox = $("#alert-box");
      const btnBack = $("#btn-back");

      function showWarn(msg){
        alertBox.textContent = msg;
        alertBox.style.display = "block";
      }
      function hideWarn(){
        alertBox.style.display = "none";
        alertBox.textContent = "";
      }

      // USER_ID (igual que en index)
      let USER_ID = (localStorage.getItem("user_id") || "").trim();
      if (!USER_ID) USER_ID = "guest";

      async function api(url, opts = {}){
        const h = opts.headers ? {...opts.headers} : {};
        if (USER_ID !== "guest" && !h["X-User-Id"]) h["X-User-Id"] = USER_ID;
        const res = await fetch(url, {...opts, headers: h});
        const txt = await res.text();
        let body;
        try{ body = JSON.parse(txt); }catch{ body = txt; }
        return { ok: res.ok, status: res.status, body };
      }

      // VOLVER INTELIGENTE (sin depender de referrer)
      function setBackLink(){
        const lastJob = (localStorage.getItem("ps_last_job_id") || "").trim();
        if (lastJob) {
          btnBack.href = `/?job_id=${encodeURIComponent(lastJob)}&user_id=${encodeURIComponent(USER_ID)}`;
          return;
        }
        btnBack.href = `/?user_id=${encodeURIComponent(USER_ID)}`;
      }

      // Badge de uso
      async function refreshBadge(){
        try{
          const r = await api(`/api/usage/balance?user_id=${encodeURIComponent(USER_ID)}`);
          if(!r.ok) return;
          const j = r.body || {};
          const used = Math.round((j.used_seconds||0)/60);
          const allow = Math.round((j.allowance_seconds||0)/60);
          const remain = Math.max(0, allow-used);
          const el = document.getElementById('usage-text');
          if(el) el.textContent = `${used}/${allow} min · libre ${remain} min`;
        }catch{}
      }

      function esc(s){
        return String(s||"").replace(/[&<>"']/g, (c) => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
        }[c]));
      }

      function pill(text){
        const sp = document.createElement("span");
        sp.className = "pill";
        sp.textContent = text;
        return sp;
      }

      function buildCard(it){
        const id = it.id || it.job_id || "";
        const filename = it.filename || (id ? ("job " + id) : "job");
        const langSel = it.language || "auto";
        const langDet = it.language_detected || "—";
        const status = it.status || "done";
        const created = it.created_at || "";

        const card = document.createElement("div");
        card.className = "card";

        const left = document.createElement("div");
        left.className = "left";

        const title = document.createElement("div");
        title.innerHTML = `<strong>${esc(filename)}</strong>`;
        left.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.appendChild(pill(`id: ${id}`));
        meta.appendChild(pill(`sel: ${langSel}`));
        meta.appendChild(pill(`det: ${langDet}`));
        meta.appendChild(pill(status));
        if (created) meta.appendChild(pill(created));
        left.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "actions";

        // VER: abre el home con job_id y user_id + guarda last job
        const aVer = document.createElement("a");
        aVer.className = "btn";
        aVer.href = `/?job_id=${encodeURIComponent(id)}&user_id=${encodeURIComponent(USER_ID)}`;
        aVer.textContent = "Ver";
        aVer.addEventListener("click", () => {
          try{ localStorage.setItem("ps_last_job_id", String(id||"")); }catch{}
        });
        actions.appendChild(aVer);

        // JSON: endpoint real
        const aJson = document.createElement("a");
        aJson.className = "btn btn-secondary";
        aJson.href = `/jobs/${encodeURIComponent(id)}?user_id=${encodeURIComponent(USER_ID)}`;
        aJson.target = "_blank";
        aJson.rel = "noopener";
        aJson.textContent = "JSON";
        actions.appendChild(aJson);

        card.appendChild(left);
        card.appendChild(actions);
        return card;
      }

      async function loadHistory(){
        hideWarn();
        cards.innerHTML = "";
        empty.style.display = "none";

        const r = await api(`/api/history?limit=100&user_id=${encodeURIComponent(USER_ID)}`);
        if(!r.ok){
          showWarn("No se pudo cargar el historial. Verifica que /api/history esté activo.");
          empty.style.display = "block";
          return;
        }

        const items = (r.body && r.body.items) ? r.body.items : [];
        if(!items.length){
          empty.style.display = "block";
          return;
        }

        items.forEach(it => cards.appendChild(buildCard(it)));
      }

      setBackLink();
      refreshBadge();
      loadHistory();
    })();
  </script>
</body>
</html>
